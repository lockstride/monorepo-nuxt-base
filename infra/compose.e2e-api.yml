name: e2e-api

x-e2e-db-url: &e2e-db-url postgresql://postgres:postgres@db:5432/postgres?schema=public

services:
  db:
    extends:
      file: ../packages/data-sources/prisma/compose.yml
      service: db
    ports: !override
      - "${DB_PORT:-5433}:5432"
  migrate:
    extends:
      file: ../packages/data-sources/prisma/compose.yml
      service: migrate
    environment:
      DATABASE_URL: *e2e-db-url
    command: ["pnpm", "prisma", "migrate", "reset", "--force"]
  api:
    extends:
      file: ../apps/api/compose.yml
      service: api
    build:
      args:
        API_PORT: ${API_PORT:-4001}
    environment:
      DATABASE_URL: *e2e-db-url
      API_PORT: ${API_PORT:-4001}
    ports: !override
      - "${API_PORT:-4001}:${API_PORT:-4001}"
    depends_on:
      migrate:
        condition: service_completed_successfully
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1:${API_PORT:-4001}/api/health",
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
